<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>File Audit Dashboard</title>
    <link rel="stylesheet" href="assets/bootstrap.min.css">
    <style>
        body { background-color: #f8f9fa; padding-top: 110px; padding-bottom: 90px;}
        .stat-card { border-radius: 10px; border: none; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .file-list { font-family: 'Courier New', Courier, monospace; font-size: 0.85rem; background: #eee; padding: 8px; border-radius: 5px; }
        .set-header { cursor: pointer; transition: background 0.2s; }
        .set-header:hover { background-color: #f1f1f1 !important; }
        .sticky-top { backdrop-filter: blur(6px); background-color: rgba(248,249,250,0.95); }
        .action-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: rgba(255, 255, 255, 0.96); border-top: 1px solid #dee2e6; padding: 10px 0; z-index: 1050;    backdrop-filter: blur(6px);  transition: transform 0.25s ease-in-out;}
        .action-bar.hidden { transform: translateY(100%); }

</style>
</head>
<body>

<!-- Install Section -->
<section id="install" class="container mt-3">
    <h2>Install Duplicate File Scanner</h2>
    <p>Select your operating system:</p>
    <div class="d-flex gap-3">
        <a href="https://github.com/Paul-codecourse/Duplicate_File_Scanner/releases/latest/download/DuplicateFileScanner-Windows-Setup.exe"
           class="btn btn-primary">ü™ü Windows</a>
        <a href="https://github.com/Paul-codecourse/Duplicate_File_Scanner/releases/latest/download/DuplicateFileScanner-Linux.AppImage"
           class="btn btn-dark">üêß Linux</a>
    </div>
</section>


<!-- Header -->
<div class="sticky-top bg-light border-bottom" style="z-index:1030;">
    <div class="container py-3">
        <header class="d-flex justify-content-between align-items-center">
            <h1 class="h4 mb-0">System File Audit</h1>
            <input type="file" id="fileInput" class="form-control w-auto" accept=".json">
        </header>

        <ul class="nav nav-tabs mt-3">
            <li class="nav-item">
                <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#tab-dupes">Duplicates</button>
            </li>
            <li class="nav-item">
                <button class="nav-link text-danger" data-bs-toggle="tab" data-bs-target="#tab-errors">Skipped Items</button>
            </li>
        </ul>
    </div>


<div class="container py-4">
    <div id="content" style="display:none;">

    <!-- Stats -->
    <div class="row g-3 mb-4">
        <div class="col-md-3"><div class="card stat-card p-3"><h6>Savings</h6><h4 id="stat-savings">-</h4></div></div>
        <div class="col-md-3"><div class="card stat-card p-3"><h6>Duplicate Sets</h6><h4 id="stat-sets">-</h4></div></div>
        <div class="col-md-3"><div class="card stat-card p-3"><h6>Total Files</h6><h4 id="stat-files">-</h4></div></div>
        <div class="col-md-3"><div class="card stat-card p-3"><h6>Scan Time</h6><h4 id="stat-time">-</h4></div></div>
    </div>

    <!-- Action Bar -->
<div id="actionBar" class="action-bar shadow-lg">
    <div class="container d-flex justify-content-between align-items-center">
        <div>
            <span id="selectedCount" class="badge bg-primary">0</span>
            <span class="text-muted ms-2">files selected</span>
        </div>
        <div class="d-flex flex-wrap gap-2">
            <button class="btn btn-sm btn-outline-warning" id="toggleSystemBtn" onclick="toggleSystemFiles()">üö´ Exclude System Files</button>
            <button class="btn btn-sm btn-outline-primary" onclick="smartSelect()">ü™Ñ Smart Select</button>
            <button class="btn btn-sm btn-outline-danger" onclick="deselectAll()">Deselect</button>
            <button class="btn btn-sm btn-outline-success" id="toggleMediaBtn" onclick="toggleMediaOnly()">üñºÔ∏è Show Media Only</button>
            <button class="btn btn-sm btn-primary" onclick="copySelectedPaths()">üìã Copy Paths</button>
        </div>
    </div>
</div>

    <!-- Tabs -->
    <div class="tab-content">
        <div class="tab-pane fade show active" id="tab-dupes">
            <div id="dupe-list"></div>
        </div>

        <div class="tab-pane fade" id="tab-errors">
            <table class="table table-sm table-hover">
                <thead class="table-light"><tr><th>Path</th><th>Reason</th></tr></thead>
                <tbody id="error-list"></tbody>
            </table>
        </div>
    </div>

</div>
</div>

<script src="assets/bootstrap.bundle.min.js"></script>
<script>
const SYSTEM_PATH_PATTERNS = [/^\.git\//, /^\/proc\//, /^\/sys\//, /^\/dev\//, /^\/run\//, /^\/etc\//];

const IMAGE_EXTENSIONS = ['jpg','jpeg','png','gif','bmp','webp','svg'];
const VIDEO_EXTENSIONS = ['mp4','mkv','avi','mov','webm','wmv','flv'];

let systemFilesHidden = false;
let mediaOnlyMode = false;

function getExtension(path) {
    return path.split('.').pop().toLowerCase();
}

function isMediaFile(path) {
    const ext = getExtension(path);
    return IMAGE_EXTENSIONS.includes(ext) || VIDEO_EXTENSIONS.includes(ext);
}


function isImageFile(path) {
    return IMAGE_EXTENSIONS.includes(getExtension(path));
}
</script>

<script>

function isSystemPath(path) {
    return SYSTEM_PATH_PATTERNS.some(rx => rx.test(path));
}

document.getElementById('fileInput').addEventListener('change', e => {
    const reader = new FileReader();
    reader.onload = ev => render(JSON.parse(ev.target.result));
    reader.readAsText(e.target.files[0]);
});

function render(data) {
    document.getElementById('content').style.display = 'block';

    document.getElementById('stat-savings').innerText =
        (data.summary.potentialSavingsBytes / 1024 / 1024 / 1024).toFixed(2) + " GB";
    document.getElementById('stat-sets').innerText = data.summary.duplicateSets;
    document.getElementById('stat-files').innerText = data.summary.totalFilesScanned;
    document.getElementById('stat-time').innerText = data.metadata.durationSeconds + "s";

    document.getElementById('dupe-list').innerHTML = data.sets.map((set,i)=>`
        <div class="card mb-2 dupe-set">
            <div class="card-header set-header" data-bs-toggle="collapse" data-bs-target="#set-${i}">
                <strong>${set.files[0].name}</strong> (${(set.size/1024).toFixed(1)} KB)
                <span class="badge bg-secondary float-end">${set.fileCount}</span>
            </div>
            <div class="collapse" id="set-${i}">
                <div class="card-body bg-light">
                    ${set.files.map(f=>{
                        const sys=isSystemPath(f.path);
                        return `
                        <div class="d-flex align-items-center mb-1 file-row"
                            data-media="${isMediaFile(f.path) ? '1' : '0'}"
                            data-image="${isImageFile(f.path) ? '1' : '0'}">

                            <input type="checkbox" class="file-check me-2"
                                value="${f.path}" data-date="${f.created}"
                                data-system="${sys?'1':'0'}"
                                onchange="updateSelectionCount()">

                            <div class="file-list flex-grow-1 ${sys?'text-muted fst-italic':''}">
                                ${f.path}
                                ${sys?' <span class="badge bg-secondary">system</span>':''}

                                <div class="thumb mt-1" style="display:none;">
                                   ${isImageFile(f.path)
                                    ? `<img src="file://${f.path}"
                                            style="max-height:80px; max-width:120px; border-radius:4px;">`
                                    : (VIDEO_EXTENSIONS.includes(getExtension(f.path))
                                        ? `<span class="badge bg-dark">video</span>`
                                        : ``)
                                }
                                </div>
                            </div>
                        </div>`;

                    }).join('')}
                </div>
            </div>
        </div>
    `).join('');

    document.getElementById('error-list').innerHTML =
        data.errors.map(e=>`<tr><td>${e.path}</td><td>${e.reason}</td></tr>`).join('');
}

function updateSelectionCount() {
    const c = document.querySelectorAll('.file-check:checked').length;
    document.getElementById('selectedCount').innerText = c;

    document.querySelectorAll('#actionBar button').forEach(btn => {
        btn.disabled = c === 0;
    });

}

function deselectAll() {
    document.querySelectorAll('.file-check').forEach(cb=>cb.checked=false);
    updateSelectionCount();
}

async function copySelectedPaths() {
    const paths=[...document.querySelectorAll('.file-check:checked')].map(cb=>cb.value).join('\n');
    await navigator.clipboard.writeText(paths);
    alert(`${paths.split('\n').length} paths copied`);
}

function toggleSystemFiles() {
    systemFilesHidden=!systemFilesHidden;
    document.querySelectorAll('.file-check[data-system="1"]').forEach(cb=>{
        cb.checked=false;
        cb.closest('.file-row').style.display=systemFilesHidden?'none':'';
    });
    document.getElementById('toggleSystemBtn').innerText=
        systemFilesHidden?'üëÅÔ∏è Show System Files':'üö´ Exclude System Files';
    updateSelectionCount();
}

function smartSelect() {
    document.querySelectorAll('.dupe-set').forEach(set=>{
        const cbs=[...set.querySelectorAll('.file-check')].sort(
            (a,b)=>new Date(a.dataset.date)-new Date(b.dataset.date)
        );
        cbs.forEach((cb,i)=>{
            if(cb.dataset.system==="1") cb.checked=false;
            else cb.checked=i!==0;
        });
    });
    updateSelectionCount();
    alert("Smart Selection Complete");
}

function toggleMediaOnly() {
    mediaOnlyMode = !mediaOnlyMode;

    document.querySelectorAll('.file-row').forEach(row => {
        const isMedia = row.dataset.media === "1";
        const thumb = row.querySelector('.thumb');

        if (mediaOnlyMode) {
            row.style.display = isMedia ? '' : 'none';
            if (thumb) thumb.style.display = 'block';
        } else {
            row.style.display = '';
            if (thumb) thumb.style.display = 'none';
        }
    });

    document.getElementById('toggleMediaBtn').innerText =
        mediaOnlyMode ? 'üìÅ Show All Files' : 'üñºÔ∏è Show Media Only';

    deselectAll();
}


</script>

<script>
let lastScrollY = window.scrollY;
const actionBar = document.getElementById('actionBar');

window.addEventListener('scroll', () => {
    const currentScrollY = window.scrollY;

    // Ignore tiny scroll jitter
    if (Math.abs(currentScrollY - lastScrollY) < 10) return;

    if (currentScrollY > lastScrollY) {
        // scrolling down ‚Üí hide
        actionBar.classList.add('hidden');
    } else {
        // scrolling up ‚Üí show
        actionBar.classList.remove('hidden');
    }

    lastScrollY = currentScrollY;
});
</script>

</body>
</html>
